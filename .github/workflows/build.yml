name: ğŸ—ï¸ Build Cross-Platform Installers

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - macos
        - linux
        - android

env:
  APP_NAME: ç¾ä¸½çš„å¾…åŠäº‹é¡¹
  APP_IDENTIFIER: com.beautifultodo.todo
  VERSION: 1.0.0

jobs:
  # macOS æ„å»ºä»»åŠ¡
  build-macos:
    runs-on: macos-latest
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'macos' || github.event.inputs.platform == ''

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½® Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: ğŸ¦ è®¾ç½® Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'

    - name: ğŸ“¦ å®‰è£… CocoaPods
      run: |
        cd macos
        pod install

    - name: ğŸ” éªŒè¯ Flutter ç¯å¢ƒ
      run: flutter doctor

    - name: ğŸ“¥ è·å–ä¾èµ–
      run: flutter pub get

    - name: ğŸ æ„å»º macOS åº”ç”¨
      run: |
        mkdir -p build/installers
        flutter build macos --release

    - name: ğŸ“¦ åˆ›å»º DMG å®‰è£…åŒ…
      run: |
        DMG_NAME="${APP_NAME}-${VERSION}.dmg"
        DMG_PATH="build/installers/${DMG_NAME}"

        # åˆ›å»ºä¸´æ—¶ç›®å½•
        TEMP_DMG_DIR="/tmp/todo_dmg"
        rm -rf "$TEMP_DMG_DIR"
        mkdir -p "$TEMP_DMG_DIR"

        # å¤åˆ¶åº”ç”¨åˆ°ä¸´æ—¶ç›®å½•
        cp -r "build/macos/Build/Products/Release/todo.app" "$TEMP_DMG_DIR/"

        # åˆ›å»º Applications é“¾æ¥
        ln -s /Applications "$TEMP_DMG_DIR/Applications"

        # åˆ›å»º DMG
        hdiutil create -volname "$APP_NAME" \
                       -srcfolder "$TEMP_DMG_DIR" \
                       -ov \
                       -format UDZO \
                       "$DMG_PATH"

        # æ¸…ç†
        rm -rf "$TEMP_DMG_DIR"

        echo "DMG_PACKAGE=$DMG_PATH" >> $GITHUB_ENV

    - name: ğŸ“¤ ä¸Šä¼  macOS æ„ä»¶
      uses: actions/upload-artifact@v3
      with:
        name: macos-installer
        path: build/installers/*.dmg
        retention-days: 30

  # Linux æ„å»ºä»»åŠ¡
  build-linux:
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'linux' || github.event.inputs.platform == ''

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ§ å®‰è£… Linux ä¾èµ–
      run: |
        sudo apt update
        sudo apt install -y \
          clang \
          cmake \
          ninja-build \
          pkg-config \
          libgtk-3-dev \
          liblzma-dev \
          libstdc++-12-dev \
          dpkg-dev \
          libappindicator3-dev \
          dpkg

    - name: ğŸ¦ è®¾ç½® Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'

    - name: ğŸ” éªŒè¯ Flutter ç¯å¢ƒ
      run: flutter doctor

    - name: ğŸ“¥ è·å–ä¾èµ–
      run: flutter pub get

    - name: ğŸ§ æ„å»º Linux åº”ç”¨
      run: |
        mkdir -p build/installers
        flutter build linux --release

    - name: ğŸ“¦ åˆ›å»º DEB å®‰è£…åŒ…
      run: |
        DEB_NAME="${APP_IDENTIFIER}_${VERSION}-1_amd64.deb"
        DEB_PATH="build/installers/${DEB_NAME}"

        # åˆ›å»º DEB åŒ…ç»“æ„
        DEB_DIR="/tmp/todo_deb"
        rm -rf "$DEB_DIR"
        mkdir -p "$DEB_DIR/DEBIAN"
        mkdir -p "$DEB_DIR/opt/todo"
        mkdir -p "$DEB_DIR/usr/share/applications"
        mkdir -p "$DEB_DIR/usr/share/icons/hicolor/256x256/apps"
        mkdir -p "$DEB_DIR/usr/bin"

        # å¤åˆ¶åº”ç”¨æ–‡ä»¶
        cp -r "build/linux/x64/release/bundle/"* "$DEB_DIR/opt/todo/"

        # åˆ›å»º desktop æ–‡ä»¶
        cat > "$DEB_DIR/usr/share/applications/todo.desktop" << EOF
        [Desktop Entry]
        Name=$APP_NAME
        Comment=ç®€æ´é«˜æ•ˆçš„ä»»åŠ¡ç®¡ç†å·¥å…·
        Exec=/opt/todo/todo
        Icon=todo
        Terminal=false
        Type=Application
        Categories=Office;Productivity;
        EOF

        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat > "$DEB_DIR/usr/bin/todo" << 'EOF'
        #!/bin/bash
        cd /opt/todo
        ./todo "$@"
        EOF
        chmod +x "$DEB_DIR/usr/bin/todo"

        # åˆ›å»º control æ–‡ä»¶
        cat > "$DEB_DIR/DEBIAN/control" << EOF
        Package: $APP_IDENTIFIER
        Version: $VERSION-1
        Section: office
        Priority: optional
        Architecture: amd64
        Depends: libgtk-3-0, libnotify4, libnss3, libxss1, libxtst6, xdg-utils, libatspi2.0-0, libdrm2, libxcomposite1, libxdamage1, libxrandr2, libgbm1, libxkbcommon0, libasound2
        Maintainer: Beautiful Todo <support@beautifultodo.com>
        Description: $APP_NAME
         ç®€æ´é«˜æ•ˆçš„ä»»åŠ¡ç®¡ç†å·¥å…·
        EOF

        # åˆ›å»ºå¸è½½è„šæœ¬
        cat > "$DEB_DIR/DEBIAN/postrm" << 'EOF'
        #!/bin/bash
        if [ "$1" = "remove" ] || [ "$1" = "purge" ]; then
            rm -rf /opt/todo
            rm -f /usr/bin/todo
            rm -f /usr/share/applications/todo.desktop
            rm -f /usr/share/icons/hicolor/256x256/apps/todo.png
            update-desktop-database
        fi
        EOF
        chmod +x "$DEB_DIR/DEBIAN/postrm"

        # è®¡ç®— installed size
        INSTALLED_SIZE=$(du -s "$DEB_DIR" | cut -f1)
        echo "Installed-Size: $INSTALLED_SIZE" >> "$DEB_DIR/DEBIAN/control"

        # æ„å»º DEB åŒ…
        dpkg-deb --build "$DEB_DIR" "$DEB_PATH"

        # æ¸…ç†
        rm -rf "$DEB_DIR"

        echo "DEB_PACKAGE=$DEB_PATH" >> $GITHUB_ENV

    - name: ğŸ“¤ ä¸Šä¼  Linux æ„ä»¶
      uses: actions/upload-artifact@v3
      with:
        name: linux-installer
        path: build/installers/*.deb
        retention-days: 30

  # Android æ„å»ºä»»åŠ¡
  build-android:
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'android' || github.event.inputs.platform == ''

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ¤– è®¾ç½® Java JDK
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ¦ è®¾ç½® Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'

    - name: ğŸ” éªŒè¯ Flutter ç¯å¢ƒ
      run: flutter doctor

    - name: ğŸ“¥ è·å–ä¾èµ–
      run: flutter pub get

    - name: ğŸ¤– æ„å»º Android APK
      run: |
        mkdir -p build/installers
        flutter build apk --release

        # é‡å‘½å APK
        APK_NAME="${APP_NAME}-${VERSION}.apk"
        cp "build/app/outputs/flutter-apk/app-release.apk" "build/installers/${APK_NAME}"

    - name: ğŸ¤– æ„å»º Android App Bundle
      run: |
        flutter build appbundle --release

        # é‡å‘½å AAB
        AAB_NAME="${APP_NAME}-${VERSION}.aab"
        cp "build/app/outputs/bundle/release/app-release.aab" "build/installers/${AAB_NAME}"

    - name: ğŸ“¤ ä¸Šä¼  Android æ„ä»¶
      uses: actions/upload-artifact@v3
      with:
        name: android-installer
        path: build/installers/*
        retention-days: 30

  # åˆ›å»º Release
  create-release:
    needs: [build-macos, build-linux, build-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„ä»¶
      uses: actions/download-artifact@v3

    - name: ğŸ“‹ åˆ›å»º Release
      uses: softprops/action-gh-release@v1
      with:
        name: "${APP_NAME} v${VERSION}"
        body: |
          ## ğŸ‰ ${APP_NAME} v${VERSION} å‘å¸ƒ

          ### ğŸ“¦ å®‰è£…åŒ…ä¸‹è½½

          #### ğŸ macOS
          - **DMG å®‰è£…åŒ…**: åŒ…å«å®Œæ•´çš„å¸è½½ç¨‹åºï¼Œæ”¯æŒæ‹–æ‹½å®‰è£…

          #### ğŸ§ Linux
          - **DEB åŒ…**: é€‚ç”¨äº Ubuntu/Debian ç³»ç»Ÿï¼ŒåŒ…å«å¸è½½è„šæœ¬

          #### ğŸ¤– Android
          - **APK**: é€‚ç”¨äºç›´æ¥å®‰è£…
          - **AAB**: é€‚ç”¨äº Google Play Store

          ### ğŸ”§ å®‰è£…è¯´æ˜
          è¯¦ç»†å®‰è£…è¯´æ˜è¯·æŸ¥çœ‹ [BUILD_GUIDE.md](./BUILD_GUIDE.md)

          ### ğŸ› é—®é¢˜åé¦ˆ
          å¦‚é‡é—®é¢˜è¯·åœ¨ Issues é¡µé¢åé¦ˆ

        files: |
          macos-installer/*.dmg
          linux-installer/*.deb
          android-installer/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}